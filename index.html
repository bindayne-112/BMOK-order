<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B√°nh M√¨ √îng K√≤i - ƒê·∫∑t H√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        window.firebaseApp = { initializeApp };
    </script>
    <script type="module">
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        window.firebaseFirestore = { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .brand-color { color: #fc6806; }
        .brand-bg { background-color: #fc6806; }
        .brand-ring:focus { --tw-ring-color: #fc6806; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        html { scroll-behavior: smooth; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-neutral-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useEffect, useMemo, useState } = React;
        
        const { initializeApp } = window.firebaseApp;
        const { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, orderBy } = window.firebaseFirestore;

        const firebaseConfig = {
            apiKey: "AIzaSyApIFFzjvfyGusxNkwTapK6H7_uIILZa9g",
            authDomain: "banh-mi-ong-koi.firebaseapp.com",
            projectId: "banh-mi-ong-koi",
            storageBucket: "banh-mi-ong-koi.appspot.com",
            messagingSenderId: "539005874689",
            appId: "1:539005874689:web:e76150504cdd6023b78600"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ===== Icon Components (SVG) =====
        const PlusIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 5v14M5 12h14" /></svg>;
        const MinusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><line x1="5" x2="19" y1="12" y2="12"/></svg>;
        const SuccessIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const PhoneIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 mr-2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81 .7A2 2 0 0 1 22 16.92z"></path></svg>;
        const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 mr-2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const ArrowRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;

        const vnd = (n) => n.toLocaleString("vi-VN", { style: "currency", currency: "VND" });
        
        // ===== UI Components =====
        const Button = ({ children, className, variant="default", ...props }) => {
            const baseClasses = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:pointer-events-none h-10 py-2 px-4";
            const variants = { default: "brand-bg text-white hover:opacity-90", outline: "border border-gray-300 bg-transparent hover:bg-neutral-100" };
            return <button className={`${baseClasses} ${variants[variant]} ${className}`} {...props}>{children}</button>
        };
        const Card = ({ children, className, ...props }) => <div className={`rounded-xl border bg-white text-neutral-950 shadow-sm ${className}`} {...props}>{children}</div>;
        const Input = ({ className, ...props }) => <input className={`flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm placeholder:text-neutral-500 focus:outline-none focus:ring-2 brand-ring ${className}`} {...props} />;
        const Textarea = ({ className, ...props }) => <textarea className={`flex min-h-[60px] w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm placeholder:text-neutral-500 focus:outline-none focus:ring-2 brand-ring ${className}`} {...props} />;

        const ItemDetailModal = ({ item, allToppingGroups, allToppings, onClose, onAddToCart }) => {
            const [quantity, setQuantity] = useState(1);
            const [note, setNote] = useState('');
            const [selectedOptions, setSelectedOptions] = useState({});

            const relevantGroups = useMemo(() => allToppingGroups.filter(g => item.toppingGroupIds?.includes(g.id) && g.name), [item, allToppingGroups]);

            useEffect(() => {
                const defaultSelections = {};
                relevantGroups.forEach(group => {
                    if (group.required) {
                        let defaultOption = allToppings.find(t => t.groupId === group.id && t.available && (group.name?.toLowerCase().includes('k√≠ch c·ª°') ? t.name.toLowerCase() === 'v·ª´a' : true));
                        if (!defaultOption) defaultOption = allToppings.find(t => t.groupId === group.id && t.available);
                        if (defaultOption) defaultSelections[group.id] = group.type === 'single' ? defaultOption.id : [defaultOption.id];
                    }
                });
                setSelectedOptions(defaultSelections);
            }, [relevantGroups, allToppings]);

            const handleOptionChange = (group, optionId) => {
                setSelectedOptions(prev => {
                    const current = prev[group.id];
                    if (group.type === 'single') return { ...prev, [group.id]: current === optionId ? null : optionId };
                    const currentArray = current || [];
                    const newSelection = currentArray.includes(optionId) ? currentArray.filter(id => id !== optionId) : [...currentArray, optionId];
                    if (newSelection.length > (group.maxSelection || 99)) return prev;
                    return { ...prev, [group.id]: newSelection };
                });
            };
            
            const total = useMemo(() => {
                const optionsPrice = Object.values(selectedOptions).flat().reduce((sum, optionId) => {
                    const option = allToppings.find(t => t.id === optionId);
                    return sum + (option ? option.price : 0);
                }, 0);
                return (item.price + optionsPrice) * quantity;
            }, [item, selectedOptions, quantity, allToppings]);
            
            const handleAddToCartClick = () => {
                const finalSelectedToppings = Object.entries(selectedOptions).flatMap(([groupId, selection]) => {
                    const group = allToppingGroups.find(g => g.id === groupId);
                    if (!group) return [];
                    const ids = Array.isArray(selection) ? selection : [selection];
                    return ids.map(id => {
                        const option = allToppings.find(t => t.id === id);
                        return option ? { groupName: group.name, ...option } : null;
                    }).filter(Boolean);
                });
                onAddToCart(item, quantity, note, finalSelectedToppings);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end">
                    <div className="absolute inset-0 bg-black/40" onClick={onClose}></div>
                    <div className="relative bg-white w-full rounded-t-2xl flex flex-col max-h-[85vh]">
                        
                        <div className="flex-shrink-0 p-4 border-b">
                            <div className="w-12 h-1.5 bg-neutral-200 rounded-full mx-auto mb-3" aria-hidden="true"></div>
                            <div className="flex items-start gap-4">
                                <img src={item.photo} alt={item.name} className="w-24 h-24 object-cover rounded-xl flex-shrink-0" onError={(e) => { e.currentTarget.src = 'https://placehold.co/100/fef2f2/ef4444?text=L·ªói'; }} />
                                <div className="flex-grow">
                                    <h2 className="text-xl font-bold text-slate-800">{item.name}</h2>
                                    <p className="text-neutral-600 text-sm mt-1 line-clamp-3">{item.description}</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-neutral-50">
                             {relevantGroups.map(group => {
                                let groupToppings = allToppings.filter(t => t.groupId === group.id);
                                if (groupToppings.length === 0) return null;
                                if (group.name?.toLowerCase().includes('k√≠ch c·ª°')) {
                                    const sizeOrder = ['nh·ªè', 'v·ª´a', 'l·ªõn'];
                                    groupToppings.sort((a, b) => sizeOrder.indexOf(a.name.toLowerCase()) - sizeOrder.indexOf(b.name.toLowerCase()));
                                }
                                return (
                                    <div key={group.id} className="bg-white p-3 rounded-xl shadow-sm">
                                        <div>
                                            <h3 className="font-semibold text-neutral-800">{group.name} {group.required && <span className="text-red-500">*</span>}</h3>
                                            <p className="text-xs text-neutral-500">{group.type === 'single' ? "Ch·ªçn 1" : `Ch·ªçn t·ªëi ƒëa ${group.maxSelection || 'nhi·ªÅu'}`}</p>
                                        </div>
                                        <div className="mt-2 space-y-2">
                                            {groupToppings.map(option => {
                                                const isChecked = group.type === 'single' ? selectedOptions[group.id] === option.id : (selectedOptions[group.id] || []).includes(option.id);
                                                const isDisabled = !option.available;
                                                return (
                                                    <label key={option.id} className={`flex items-center justify-between p-3 bg-neutral-50 rounded-lg ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}>
                                                        <div>
                                                            <p className="font-medium text-neutral-700">{option.name}</p>
                                                            <p className="text-sm brand-color font-semibold">+{vnd(option.price)}</p>
                                                        </div>
                                                        <input 
                                                            type={group.type === 'single' ? 'radio' : 'checkbox'} 
                                                            name={`group-${group.id}`} 
                                                            checked={isChecked && !isDisabled}
                                                            onChange={() => !isDisabled && handleOptionChange(group, option.id)} 
                                                            disabled={isDisabled}
                                                            className="h-5 w-5 rounded-full border-neutral-300 text-orange-600 focus:ring-orange-500 cursor-pointer disabled:cursor-not-allowed disabled:bg-neutral-200" />
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                            <div className="bg-white p-3 rounded-xl shadow-sm">
                                <h3 className="font-semibold text-neutral-800">Ghi ch√∫</h3>
                                <Textarea className="mt-2" value={note} onChange={e => setNote(e.target.value)} placeholder="D·∫∑n d√≤ th√™m cho qu√°n..."/>
                            </div>
                        </div>

                        <div className="flex-shrink-0 p-3 border-t bg-white/80 backdrop-blur-lg flex items-center justify-between gap-3 pb-safe">
                            <div className="flex items-center gap-2">
                               <button onClick={() => setQuantity(q => Math.max(1, q - 1))} className="h-10 w-10 flex items-center justify-center rounded-full border bg-neutral-100 text-neutral-700 font-bold text-xl">-</button>
                               <span className="font-bold text-xl w-8 text-center">{quantity}</span>
                               <button onClick={() => setQuantity(q => q + 1)} className="h-10 w-10 flex items-center justify-center rounded-full border bg-neutral-100 text-neutral-700 font-bold text-xl">+</button>
                            </div>
                            <Button onClick={handleAddToCartClick} className="flex-1 h-10 rounded-xl font-semibold">Th√™m v√†o gi·ªè - {vnd(total)}</Button>
                        </div>
                    </div>
                </div>
            );
        }
        
        const ThankYouPage = ({ order, onNewOrder }) => {
            if (!order) return null;

            const getStatusDisplay = (status) => {
              const s = typeof status === 'string' ? status.trim().toLowerCase() : '';
              switch (s) {
                  case 'pending': return { text: 'ƒêang ch·ªù x√°c nh·∫≠n', className: 'text-yellow-600' };
                  case 'confirmed': return { text: 'Qu√°n ƒë√£ x√°c nh·∫≠n', className: 'text-green-600' };
                  case 'processing': case 'preparing': return { text: 'ƒêang th·ª±c hi·ªán', className: 'text-blue-600' };
                  case 'ready': return { text: 'S·∫µn s√†ng giao', className: 'text-purple-600' };
                  case 'completed': return { text: 'Ho√†n th√†nh', className: 'text-green-700' };
                  case 'cancelled': case 'canceled': return { text: 'ƒê√£ h·ªßy', className: 'text-red-600' };
                  default: return { text: 'Kh√¥ng x√°c ƒë·ªãnh', className: 'text-gray-600' };
              }
            };
            const statusDisplay = getStatusDisplay(order.status);

            return (
                <div className="flex flex-col items-center text-center pt-8 pb-16 px-4">
                    <div className="text-green-500"><SuccessIcon/></div>
                    <h2 className="text-2xl font-bold mt-4">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h2>
                    <p className="text-neutral-500 mt-2 text-sm max-w-xs mx-auto">C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng. Vui l√≤ng theo d√µi tr·∫°ng th√°i ƒë∆°n h√†ng d∆∞·ªõi ƒë√¢y.</p>
                    <div className="w-full max-w-sm mt-8 text-left rounded-lg p-4 bg-white shadow-sm border">
                         <h3 className="font-semibold pb-3 text-base border-b text-neutral-800">T√≥m t·∫Øt ƒë∆°n h√†ng #{String(order.createdAt).slice(-6)}</h3>
                         <ul className="text-sm divide-y text-neutral-700">
                             {order.items.map((item, index) => (
                                 <li key={index} className="flex justify-between py-3">
                                     <span>{item.qty} x {item.name}</span>
                                     <span className="font-medium">{vnd(item.qty * item.totalPrice)}</span>
                                 </li>
                             ))}
                         </ul>
                         <div className="border-t pt-3 flex justify-between font-bold text-base text-neutral-800">
                             <span>T·ªïng c·ªông</span>
                             <span>{vnd(order.total)}</span>
                         </div>
                         <div className="mt-3 pt-3 border-t text-sm flex justify-between items-center">
                            <span className="text-neutral-600">Tr·∫°ng th√°i:</span>
                            <span className={`font-bold ${statusDisplay.className}`}>{statusDisplay.text}</span>
                         </div>
                    </div>
                    <Button className="w-full max-w-sm mt-8 rounded-lg h-12 text-base" onClick={onNewOrder}>ƒê·∫∑t ƒë∆°n h√†ng m·ªõi</Button>
                </div>
            );
        };

        const QrCodeModal = ({ total, onClose }) => {
            const qrCodeUrl = "https://img.vietqr.io/image/TCB-7989696969-compact.png";
            const accountName = "MAI CHI VY";
            const accountNumber = "7989696969";
            const bankName = "TECHCOMBANK";

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60">
                    <div className="relative bg-white rounded-2xl shadow-xl p-6 w-full max-w-xs m-4 text-center">
                        <h3 className="text-lg font-semibold mb-2">Qu√©t m√£ ƒë·ªÉ thanh to√°n</h3>
                        <p className="text-sm text-neutral-500 mb-4">S·ª≠ d·ª•ng app ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠ c·ªßa b·∫°n.</p>
                        <img src={qrCodeUrl} alt="M√£ QR thanh to√°n" className="w-full h-auto rounded-lg border" />
                        <div className="mt-4 text-sm text-left space-y-2">
                            <p><strong>S·ªë ti·ªÅn:</strong> <span className="font-bold text-lg brand-color">{vnd(total)}</span></p>
                            <p><strong>Ch·ªß t√†i kho·∫£n:</strong> <span className="font-semibold">{accountName}</span></p>
                            <p><strong>S·ªë t√†i kho·∫£n:</strong> <span className="font-semibold">{accountNumber}</span></p>
                            <p><strong>Ng√¢n h√†ng:</strong> <span className="font-semibold">{bankName}</span></p>
                        </div>
                        <Button variant="outline" className="w-full mt-6" onClick={onClose}>ƒê√≥ng</Button>
                    </div>
                </div>
            );
        };
        
        const DealItemCard = ({ item, quantity, onClick, onAdd, onDecrease }) => {
            return (
                <div className="relative flex-shrink-0 w-48 bg-white rounded-2xl shadow-md p-3 flex flex-col gap-2 cursor-pointer active:bg-neutral-50" onClick={onClick}>
                    {(item.bestSeller || item.isNewDish) && (
                        <div className="absolute top-0 left-0 text-xs font-semibold text-white px-2 py-1 rounded-br-lg bg-orange-500 z-10">
                            {item.bestSeller ? 'B√°n ch·∫°y' : 'M√≥n m·ªõi'}
                        </div>
                    )}
                    <img src={item.photo} alt={item.name} className="w-full h-24 object-cover rounded-lg"/>
                    <div className="flex-1 flex flex-col justify-between">
                        <p className="font-bold text-neutral-800 leading-tight">{item.name}</p>
                        <div className="flex items-center justify-between mt-2">
                           <div className="flex flex-col">
                             <p className="font-semibold brand-color">{vnd(item.price)}</p>
                             {item.compareAtPrice > item.price && <p className="text-xs text-neutral-400 line-through">{vnd(item.compareAtPrice)}</p>}
                           </div>
                            {quantity > 0 ? (
                                <div className="flex items-center gap-1 rounded-full border bg-white shadow-sm">
                                    <button onClick={(e) => {e.stopPropagation(); onDecrease(item.id)}} className="rounded-full w-7 h-7 flex items-center justify-center"><MinusIcon/></button>
                                    <span className="font-bold w-4 text-center text-sm">{quantity}</span>
                                    <button onClick={(e) => {e.stopPropagation(); onAdd(item)}} className="rounded-full w-7 h-7 flex items-center justify-center brand-bg text-white"><PlusIcon className="w-4 h-4"/></button>
                                </div>
                            ) : (
                                <button onClick={(e) => { e.stopPropagation(); onAdd(item); }} className="h-8 w-8 flex items-center justify-center rounded-full brand-bg text-white shadow-lg transform active:scale-90 transition-transform">
                                    <PlusIcon className="w-5 h-5" />
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            )
        }

        function App() {
          const [menu, setMenu] = useState([]);
          const [categories, setCategories] = useState([]);
          const [toppingGroups, setToppingGroups] = useState([]);
          const [toppings, setToppings] = useState([]);
          const [storeStatus, setStoreStatus] = useState({ isOpen: true });
          const [loading, setLoading] = useState(true);
          const [cart, setCart] = useState([]);
          const [openCart, setOpenCart] = useState(false);
          const [selectedItem, setSelectedItem] = useState(null);
          const [contact, setContact] = useState("");
          const [address, setAddress] = useState("");
          const [paymentMethod, setPaymentMethod] = useState("TIENMAT");
          const [activeCategory, setActiveCategory] = useState('');
          const [view, setView] = useState('menu');
          const [lastOrder, setLastOrder] = useState(null);
          const [showQrModal, setShowQrModal] = useState(false);
          const [validationError, setValidationError] = useState('');
          const [isCustomAddress, setIsCustomAddress] = useState(false);
          const PRESET_ADDRESS = "R·ªòT T·ªòT CAFE - Ho√†ng VƒÉn Th·ª•";

          const FREE_SHIP_THRESHOLD = 20000;
          const SHIPPING_FEE = 5000;

          useEffect(() => {
            const savedContact = localStorage.getItem('banhMiOngKoiContact');
            if (savedContact) setContact(savedContact);
            const savedAddress = localStorage.getItem('banhMiOngKoiAddress');
            if (savedAddress) {
                setAddress(savedAddress);
                setIsCustomAddress(savedAddress !== PRESET_ADDRESS);
            } else {
                setAddress(PRESET_ADDRESS);
                setIsCustomAddress(false);
            }
            const savedOrder = localStorage.getItem('banhMiOngKoiLastOrder');
            if (savedOrder) { 
                setLastOrder(JSON.parse(savedOrder)); 
                setView('thankyou'); 
            }
          }, []);

          useEffect(() => {
            const unsubscribers = [];
            const collectionsToFetch = [
                { name: "menu", setter: setMenu, query: query(collection(db, "menu"), orderBy("order", "asc")) },
                { name: "categories", setter: setCategories, query: query(collection(db, "categories"), orderBy("name", "asc")) },
                { name: "toppingGroups", setter: setToppingGroups, query: query(collection(db, "toppingGroups"), orderBy("name", "asc")) },
                { name: "toppings", setter: setToppings, query: query(collection(db, "toppings")) }
            ];
            collectionsToFetch.forEach(({ name, setter, query: q }) => {
                unsubscribers.push(onSnapshot(q, (snapshot) => {
                     const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     setter(data);
                     if (name === "categories" && data.length > 0 && !activeCategory) setActiveCategory(data[0].name);
                }));
            });
            const storeStatusRef = doc(db, "settings", "storeStatus");
            unsubscribers.push(onSnapshot(storeStatusRef, (doc) => doc.exists() ? setStoreStatus(doc.data()) : setDoc(doc.ref, { isOpen: true })));
            
            const loadingTimeout = setTimeout(() => setLoading(false), 5000);
            return () => { unsubscribers.forEach(unsub => unsub()); clearTimeout(loadingTimeout); };
          }, []);
           
          useEffect(() => {
            if (lastOrder?.id) {
                const orderRef = doc(db, "orders", lastOrder.id);
                const unsubscribe = onSnapshot(orderRef, (doc) => {
                    if (doc.exists()) {
                        const updatedOrder = {id: doc.id, ...doc.data()};
                        setLastOrder(updatedOrder);
                        localStorage.setItem('banhMiOngKoiLastOrder', JSON.stringify(updatedOrder));
                    }
                });
                return () => unsubscribe();
            }
          }, [lastOrder?.id]);

          const handleAddToCart = (item, quantity, note, selectedToppings) => {
              const optionsPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
              const newCartItem = { cartId: `${item.id}-${Date.now()}`, id: item.id, name: item.name, totalPrice: item.price + optionsPrice, qty: quantity, note, selectedToppings };
              setCart(prev => [...prev, newCartItem]);
          };

          const addOrIncreaseSimpleItem = (item) => {
              if (!item.available || !storeStatus.isOpen) return;
              setCart(prev => {
                  const existing = prev.find(ci => ci.id === item.id && !ci.selectedToppings?.length && !ci.note);
                  if (existing) return prev.map(ci => ci.cartId === existing.cartId ? { ...ci, qty: ci.qty + 1 } : ci);
                  return [...prev, { cartId: `${item.id}-${Date.now()}`, id: item.id, name: item.name, totalPrice: item.price, qty: 1, note: '', selectedToppings: [] }];
              });
          };

          const decreaseSimpleItem = (itemId) => {
              setCart(prev => {
                  const existing = prev.find(c => c.id === itemId && !c.selectedToppings?.length && !c.note);
                  if (!existing) return prev;
                  if (existing.qty === 1) return prev.filter(c => c.cartId !== existing.cartId);
                  return prev.map(c => c.cartId === existing.cartId ? { ...c, qty: c.qty - 1 } : c);
              });
          };
          
          const increaseCartQty = (cartId) => setCart(cart.map(i => i.cartId === cartId ? {...i, qty: i.qty + 1} : i));
          const decreaseCartQty = (cartId) => setCart(cart.map(i => i.cartId === cartId ? {...i, qty: Math.max(0, i.qty - 1)} : i).filter(i => i.qty > 0));

          const subtotal = useMemo(() => cart.reduce((sum, item) => sum + (item.totalPrice * item.qty), 0), [cart]);
          const isFreeship = useMemo(() => subtotal >= FREE_SHIP_THRESHOLD, [subtotal]);
          const totalCartPrice = useMemo(() => subtotal + (isFreeship ? 0 : SHIPPING_FEE), [subtotal, isFreeship]);
          
          const dealOfDayItems = useMemo(() => menu.filter(item => item.isDealOfDay && item.available), [menu]);

          const displayMenu = useMemo(() => {
            return categories.map(cat => ({ category: cat.name, items: menu.filter(item => item.category === cat.name) })).filter(g => g.items.length > 0);
          }, [menu, categories]);

          const scrollToCategory = (categoryName) => {
            const el = document.getElementById(`category-${categoryName}`);
            if (el) {
                const offset = 60;
                const bodyRect = document.body.getBoundingClientRect().top;
                const elRect = el.getBoundingClientRect().top;
                const elPos = elRect - bodyRect;
                const offsetPos = elPos - offset;
                window.scrollTo({ top: offsetPos, behavior: "smooth" });
                setActiveCategory(categoryName);
            }
          };

          const handleItemClick = (item) => {
              if (!item.available || !storeStatus.isOpen) return;
              item.toppingGroupIds?.length ? setSelectedItem(item) : addOrIncreaseSimpleItem(item);
          };

          const checkout = async () => {
              if (!/^0\d{9}$/.test(contact)) { setValidationError('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.'); return; }
              if (!address.trim()) { setValidationError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.'); return; }
              if (cart.length === 0) return;
              setValidationError('');
              try {
                  const items = cart.map(i => ({ name: i.name, qty: i.qty, totalPrice: i.totalPrice, note: i.note || '', selectedToppings: i.selectedToppings.map(t => ({ name: t.name, price: t.price })) }));
                  const orderData = { items, subtotal, shippingFee: isFreeship ? 0 : SHIPPING_FEE, total: totalCartPrice, contact: contact.trim(), address: address.trim(), status: "pending", payment: paymentMethod, createdAt: Date.now() };
                  const docRef = await addDoc(collection(db, "orders"), orderData);
                  const finalOrder = { id: docRef.id, ...orderData };
                  localStorage.setItem('banhMiOngKoiContact', contact.trim());
                  localStorage.setItem('banhMiOngKoiAddress', address.trim());
                  localStorage.setItem('banhMiOngKoiLastOrder', JSON.stringify(finalOrder));
                  setLastOrder(finalOrder);
                  setView('thankyou');
                  setCart([]);
                  setOpenCart(false);
              } catch (error) { setValidationError("L·ªói khi ƒë·∫∑t h√†ng, vui l√≤ng th·ª≠ l·∫°i."); }
          };

          const handleNewOrderClick = () => {
              localStorage.removeItem('banhMiOngKoiLastOrder');
              setLastOrder(null);
              setView('menu');
          };


          if (loading && menu.length === 0) {
              return (
                <div className="min-h-screen flex flex-col items-center justify-center text-center p-4">
                    <svg className="animate-spin h-8 w-8 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p className="mt-3 text-neutral-600">ƒêang t·∫£i th·ª±c ƒë∆°n...</p>
                </div>
              );
          }

          return (
            <div className="min-h-screen max-w-md mx-auto bg-white">
              <header className="bg-gradient-to-r from-orange-500 to-orange-400 text-white shadow-md p-4">
                  <h1 className="font-bold text-2xl text-center">B√ÅNH M√å √îNG K√íI</h1>
                  <p className="text-sm text-orange-100 text-center mt-1">FREESHIP - GIAO H√ÄNG T·∫¨N N∆†I</p>
                   <div className="mt-3 text-sm text-orange-100 space-y-1 border-t border-white/20 pt-3 flex flex-col items-center">
                      <p className="flex items-center"><PhoneIcon /><a href="tel:0768986969" className="font-semibold">07.6898.6969</a></p>
                      <p className="flex items-center mt-1"><MapPinIcon /><span>306 Nguy·ªÖn Ho√†ng, TP.ƒê√† N·∫µng</span></p>
                  </div>
              </header>
              
              <main className="pb-32 bg-neutral-50">
                {view === 'menu' ? (
                  <>
                    {!storeStatus.isOpen && (<div className="p-4 m-4 text-center bg-red-100 text-red-800 rounded-lg"><p className="font-bold">C·ª≠a h√†ng ƒëang t·∫°m ƒë√≥ng c·ª≠a!</p><p className="text-sm">Xin l·ªói qu√Ω kh√°ch v√¨ s·ª± b·∫•t ti·ªán n√†y.</p></div>)}
                    
                    {dealOfDayItems.length > 0 && (
                        <section className="py-4 bg-white">
                            <div className="flex justify-between items-center px-4 mb-3">
                                <h2 className="text-xl font-bold text-neutral-800">∆Øu ƒë√£i h√¥m nay</h2>
                                <button className="p-2 rounded-full hover:bg-neutral-100 active:bg-neutral-200">
                                    <ArrowRightIcon />
                                </button>
                            </div>
                            <div className="flex gap-3 overflow-x-auto scrollbar-hide px-4">
                                {dealOfDayItems.map(item => {
                                    const simpleCartItem = cart.find(c => c.id === item.id && !c.selectedToppings?.length && !c.note);
                                    return (
                                        <DealItemCard 
                                            key={item.id} 
                                            item={item} 
                                            quantity={simpleCartItem?.qty || 0}
                                            onClick={() => handleItemClick(item)} 
                                            onAdd={addOrIncreaseSimpleItem}
                                            onDecrease={decreaseSimpleItem}
                                        />
                                    )
                                })}
                            </div>
                        </section>
                    )}

                    <nav className="sticky top-0 bg-white/80 backdrop-blur-sm z-30 py-3 border-y">
                        <div className="px-4"><div className="flex space-x-3 overflow-x-auto scrollbar-hide">
                            {displayMenu.map(g => <button key={g.category} onClick={() => scrollToCategory(g.category)} className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${activeCategory === g.category ? `brand-bg text-white shadow-md` : 'bg-white text-neutral-700 shadow-sm'}`}>{g.category}</button>)}
                        </div></div>
                    </nav>

                    <div className="mt-5 space-y-8 px-4">
                        {displayMenu.map(group => (
                            <section key={group.category} id={`category-${group.category}`}>
                                <h3 className="text-2xl font-bold mb-4 text-neutral-800">{group.category}</h3>
                                <div className="space-y-3">
                                    {group.items.map(m => {
                                        const simpleCartItem = cart.find(c => c.id === m.id && !c.selectedToppings?.length);
                                        return (
                                            <Card key={m.id} onClick={() => handleItemClick(m)} className={`relative overflow-hidden ${m.available && storeStatus.isOpen ? 'cursor-pointer active:bg-neutral-50' : ''}`}>
                                                
                                                {(m.bestSeller || m.isNewDish) && (
                                                  <div className="absolute top-0 left-0 text-xs font-semibold text-white px-2 py-1 rounded-br-lg bg-orange-500 z-10">
                                                      {m.bestSeller ? 'B√°n ch·∫°y' : 'M√≥n m·ªõi'}
                                                  </div>
                                                )}

                                                <div className="flex items-center p-3 gap-3">
                                                    <img src={m.photo} alt={m.name} className="w-20 h-20 object-cover rounded-md flex-shrink-0" onError={(e) => { e.currentTarget.src = 'https://placehold.co/100/fef2f2/ef4444?text=L·ªói'; }}/>
                                                    <div className="flex-grow self-start">
                                                        <h4 className="font-bold text-base leading-tight">{m.name}</h4>
                                                        {m.description && <p className="text-sm text-neutral-500 mt-1 line-clamp-2">{m.description}</p>}
                                                        <div className="flex items-center gap-2 mt-2">
                                                            <p className="font-semibold text-base brand-color">{vnd(m.price)}</p>
                                                            {m.compareAtPrice > m.price && <p className="text-sm text-neutral-400 line-through">{vnd(m.compareAtPrice)}</p>}
                                                        </div>
                                                    </div>
                                                    <div className="flex-shrink-0 self-end">
                                                        {simpleCartItem?.qty > 0 ? (
                                                            <div className="flex items-center gap-2">
                                                                <button onClick={(e) => {e.stopPropagation(); decreaseSimpleItem(m.id)}} className="rounded-full w-8 h-8 flex items-center justify-center border bg-white"><MinusIcon/></button>
                                                                <span className="font-bold w-6 text-center">{simpleCartItem.qty}</span>
                                                                <button onClick={(e) => {e.stopPropagation(); addOrIncreaseSimpleItem(m)}} className="rounded-full w-8 h-8 flex items-center justify-center brand-bg text-white"><PlusIcon className="w-5 h-5"/></button>
                                                            </div>
                                                        ) : ( <button onClick={(e) => {e.stopPropagation(); handleItemClick(m)}} className="h-8 w-8 flex items-center justify-center rounded-full brand-bg text-white shadow"><PlusIcon className="w-5 h-5"/></button> )}
                                                    </div>
                                                </div>
                                                {!m.available && <div className="absolute inset-0 bg-white/70 flex items-center justify-center rounded-xl"><span className="text-black font-semibold border bg-white px-2 py-1 rounded-md">H·∫øt h√†ng</span></div>}
                                            </Card>
                                        )
                                    })}
                                </div>
                            </section>
                        ))}
                    </div>
                  </>
                ) : ( <ThankYouPage order={lastOrder} onNewOrder={handleNewOrderClick} /> )}
              </main>

              {view === 'menu' && cart.length > 0 && (
                <div className="fixed bottom-0 left-0 right-0 z-30"><div className="max-w-md mx-auto p-2 pb-safe">
                    <Button className="w-full h-12 rounded-xl text-base shadow-lg" onClick={()=> setOpenCart(true)}>
                        <div className="flex items-center justify-between w-full px-4">
                            <span>{cart.reduce((s,i)=>s+i.qty,0)} m√≥n</span>
                            <span className="font-bold">{vnd(totalCartPrice)}</span>
                        </div>
                    </Button>
                </div></div>
              )}

              {view === 'menu' && openCart && (
                 <div className="fixed inset-0 z-50 flex flex-col justify-end">
                  <div className="absolute inset-0 bg-black/60" onClick={() => setOpenCart(false)}></div>
                  <div className={`relative bg-neutral-50 rounded-t-2xl shadow-xl flex flex-col max-h-[85vh] transition-transform duration-300 ${openCart ? 'translate-y-0' : 'translate-y-full'}`}>
                      <div className="p-4 border-b bg-white flex-shrink-0 rounded-t-2xl">
                        <div className="w-12 h-1.5 bg-neutral-200 rounded-full mx-auto mb-2"></div>
                        <h2 className="text-lg font-semibold text-center">T√≥m t·∫Øt ƒë∆°n h√†ng</h2>
                      </div>
                      <div className="flex-1 p-4 space-y-3 overflow-y-auto">
                        {cart.map(c => (
                            <Card key={c.cartId}><div className="p-3">
                                <div className="flex items-start justify-between gap-3">
                                    <div className="flex-grow">
                                        <p className="font-medium">{c.name}</p>
                                        {c.selectedToppings.length > 0 && <div className="pl-2 mt-1 text-xs text-neutral-500 border-l-2 ml-1 space-y-0.5">{c.selectedToppings.map(t => <p key={t.id}>+ {t.name}</p>)}</div>}
                                        {c.note && <p className="text-xs text-blue-600 mt-1">Ghi ch√∫: {c.note}</p>}
                                    </div>
                                    <div className="flex flex-col items-end shrink-0">
                                        <p className="font-semibold">{vnd(c.totalPrice * c.qty)}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            <button className="rounded-full w-7 h-7 flex items-center justify-center border bg-white" onClick={()=>decreaseCartQty(c.cartId)}><MinusIcon/></button>
                                            <span className="font-bold w-6 text-center">{c.qty}</span>
                                            <button className="rounded-full w-7 h-7 flex items-center justify-center border bg-white" onClick={()=>increaseCartQty(c.cartId)}><PlusIcon/></button>
                                        </div>
                                    </div>
                                </div>
                            </div></Card>
                        ))}
                      </div>
                      <div className="p-3 border-t bg-white space-y-3 flex-shrink-0 pb-safe">
                          <div className="text-sm space-y-1">
                              <div className="flex justify-between">
                                  <span>T·∫°m t√≠nh</span>
                                  <span>{vnd(subtotal)}</span>
                              </div>
                              <div className="flex justify-between">
                                  <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                                  {isFreeship ? (
                                      <span className="font-semibold text-green-600">Mi·ªÖn ph√≠</span>
                                  ) : (
                                      <span>{vnd(SHIPPING_FEE)}</span>
                                  )}
                              </div>
                              {!isFreeship && subtotal > 0 && (
                                <div className="text-center text-xs text-green-600 font-medium py-1">
                                    Mua th√™m {vnd(FREE_SHIP_THRESHOLD - subtotal)} ƒë·ªÉ ƒë∆∞·ª£c mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn!
                                </div>
                              )}
                          </div>
                          <div className="space-y-3">
                            <Input placeholder="SƒêT/Zalo (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0)" value={contact} onChange={e => setContact(e.target.value)} type="tel" maxLength={10} />
                            <div>
                                <div className="p-1 bg-neutral-100 rounded-lg flex">
                                    <button onClick={() => { setAddress(PRESET_ADDRESS); setIsCustomAddress(false); }} className={`flex-1 p-2 rounded-md text-sm text-center font-semibold transition-colors ${!isCustomAddress ? 'bg-white shadow-sm' : 'text-neutral-600'}`}>
                                        üìç R·ªòT T·ªòT CAFE
                                    </button>
                                    <button onClick={() => { setIsCustomAddress(true); if(address === PRESET_ADDRESS) setAddress(''); }} className={`flex-1 p-2 rounded-md text-sm text-center font-semibold transition-colors ${isCustomAddress ? 'bg-white shadow-sm' : 'text-neutral-600'}`}>
                                        üõµ Giao n∆°i kh√°c
                                    </button>
                                </div>
                                {isCustomAddress && (
                                    <Input 
                                        className="mt-2"
                                        placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng" 
                                        value={address} 
                                        onChange={e => setAddress(e.target.value)} 
                                        type="text" 
                                    />
                                )}
                            </div>
                            {validationError && <p className="text-red-500 text-xs mt-1 text-center">{validationError}</p>}
                          </div>
                           <div>
                              <div className="text-sm font-medium mb-2">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
                              <div className="grid grid-cols-2 gap-2">
                                  <button onClick={() => setPaymentMethod('TIENMAT')} className={`p-3 rounded-lg border text-sm text-center ${paymentMethod === 'TIENMAT' ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-500' : 'bg-white'}`}>Ti·ªÅn m·∫∑t</button>
                                  <button onClick={() => { setPaymentMethod('CHUYENKHOAN'); setShowQrModal(true); }} className={`p-3 rounded-lg border text-sm text-center ${paymentMethod === 'CHUYENKHOAN' ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-500' : 'bg-white'}`}>Chuy·ªÉn kho·∫£n</button>
                              </div>
                          </div>
                          <div className="flex items-center justify-between font-semibold text-lg border-t pt-3 mt-1"><span>T·ªïng c·ªông</span><span className="brand-color">{vnd(totalCartPrice)}</span></div>
                          <Button className="w-full h-11 rounded-xl text-base" onClick={checkout}>ƒê·∫∑t h√†ng</Button>
                      </div>
                  </div>
                </div>
              )}
              
              {selectedItem && <ItemDetailModal item={selectedItem} allToppingGroups={toppingGroups} allToppings={toppings} onClose={() => setSelectedItem(null)} onAddToCart={handleAddToCart} />}
              {showQrModal && <QrCodeModal total={totalCartPrice} onClose={() => setShowQrModal(false)} />}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>

