<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bánh Mì Ông Kòi</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tải Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        window.firebaseApp = { initializeApp };
    </script>
    <script type="module">
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        window.firebaseFirestore = { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setDoc, updateDoc, query, orderBy };
    </script>
    <style>
        /* Ẩn thanh cuộn cho trình duyệt Webkit (Chrome, Safari) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Ẩn thanh cuộn cho Firefox */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-neutral-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useEffect, useMemo, useState, useCallback, useRef } = React;

        // ========================================================================
        // ===== BẮT ĐẦU CODE ỨNG DỤNG ==========================================
        // ========================================================================
        
        const { initializeApp } = window.firebaseApp;
        const { 
            getFirestore, collection, onSnapshot, 
            addDoc, deleteDoc, doc, setDoc, updateDoc,
            query, orderBy
        } = window.firebaseFirestore;

        // !!! CẢNH BÁO BẢO MẬT !!!
        // KHÔNG BAO GIỜ ĐỂ THÔNG TIN NHẠY CẢM NHƯ API KEY TRONG MÃ NGUỒN PHÍA CLIENT
        // HÃY SỬ DỤNG BIẾN MÔI TRƯỜNG VÀ THIẾT LẬP FIREBASE SECURITY RULES CHẶT CHẼ
        const firebaseConfig = {
            apiKey: "AIzaSyApIFFzjvfyGusxNkwTapK6H7_uIILZa9g",
            authDomain: "banh-mi-ong-koi.firebaseapp.com",
            projectId: "banh-mi-ong-koi",
            storageBucket: "banh-mi-ong-koi.appspot.com",
            messagingSenderId: "539005874689",
            appId: "1:539005874689:web:e76150504cdd6023b78600"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const BRAND_COLOR = "#fc6806";

        // ===== Icon Components (SVG) =====
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>;
        const MinusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><line x1="5" x2="19" y1="12" y2="12"/></svg>;
        const NoteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 mr-1.5 text-gray-400"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>;
        const StarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const PinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4 mr-1"><path d="M12 17v5"/><path d="M15 9.34V4a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v12l3-3h5.34"/><path d="m15 9.34 5.5 5.5"/><path d="m20.5 14.84-5.5-5.5"/><path d="M18 22h4v-4"/></svg>;
        const ArrowUpIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>;
        const ArrowDownIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>;
        const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const Trash2Icon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const ArrowRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;

        // ===== Custom UI Components =====
        const Button = ({ children, className, variant = 'default', size = 'default', ...props }) => {
          const baseClasses = "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none disabled:opacity-50 disabled:pointer-events-none";
          const variants = {
            default: `bg-[${BRAND_COLOR}] text-white hover:bg-opacity-90`,
            destructive: "bg-red-600 text-white hover:bg-red-600/90",
            outline: "border border-gray-300 bg-transparent hover:bg-neutral-100",
          };
          const sizes = { default: "h-10 py-2 px-4", sm: "h-9 px-3 rounded-md", icon: "h-10 w-10" };
          return <button className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`} {...props}>{children}</button>;
        };
        const Card = ({ children, className, ...props }) => <div className={`rounded-xl border bg-white text-neutral-950 shadow-sm ${className}`} {...props}>{children}</div>;
        const CardContent = ({ children, className, ...props }) => <div className={`p-3 ${className}`} {...props}>{children}</div>;
        const Input = ({ className, ...props }) => <input className={`flex h-10 w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-orange-400 ${className}`} {...props} />;
        const Textarea = ({ className, ...props }) => <textarea className={`flex min-h-[60px] w-full rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-orange-400 ${className}`} {...props} />;
        const Select = ({ children, className, ...props }) => <select className={`flex h-10 w-full items-center justify-between rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`} {...props}>{children}</select>;
        const SelectItem = ({ children, ...props }) => <option {...props}>{children}</option>;
        
        // ===== Utils & Audio =====
        const vnd = (n) => n.toLocaleString("vi-VN", { style: "currency", currency: "VND" });
        const playNotificationSound = () => {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.error("Could not play notification sound:", error);
            }
        };

        function App() {
          // State management
          const [menu, setMenu] = useState([]);
          const [categories, setCategories] = useState([]);
          const [orders, setOrders] = useState([]);
          const [storeStatus, setStoreStatus] = useState({ isOpen: true });
          const [loading, setLoading] = useState(true);
          const [cart, setCart] = useState([]);
          const [contact, setContact] = useState("");
          const [paymentMethod, setPaymentMethod] = useState("TIENMAT");
          const [openCart, setOpenCart] = useState(false);
          const [tab, setTab] = useState("khach");
          const [adminTab, setAdminTab] = useState("orders");
          const [newItem, setNewItem] = useState({ name: "", price: "", compareAtPrice: "", photo: "", category: "" });
          const [newCategory, setNewCategory] = useState("");
          const [itemToDelete, setItemToDelete] = useState(null);
          const [categoryToDelete, setCategoryToDelete] = useState(null);
          
          const isInitialLoad = useRef(true);

          // Data fetching from Firebase
          useEffect(() => {
            const unsubscribers = [];
            
            const menuQuery = query(collection(db, "menu"), orderBy("order", "asc"));
            unsubscribers.push(onSnapshot(menuQuery, (snapshot) => {
                setMenu(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                setLoading(false);
            }, (error) => console.error("Error fetching menu:", error)));

            const categoriesQuery = query(collection(db, "categories"), orderBy("name", "asc"));
            unsubscribers.push(onSnapshot(categoriesQuery, (snapshot) => {
                const catData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCategories(catData);
                if (newItem.category === "" && catData.length > 0) {
                    setNewItem(prev => ({ ...prev, category: catData[0].name }));
                }
            }, (error) => console.error("Error fetching categories:", error)));

            const ordersQuery = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            unsubscribers.push(onSnapshot(ordersQuery, (snapshot) => {
                const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isInitialLoad.current) {
                    isInitialLoad.current = false;
                } else if (newOrders.length > orders.length) {
                    playNotificationSound();
                }
                setOrders(newOrders);
            }, (error) => console.error("Error fetching orders:", error)));

            const storeStatusRef = doc(db, "settings", "storeStatus");
            unsubscribers.push(onSnapshot(storeStatusRef, (doc) => {
                if (doc.exists()) {
                    setStoreStatus(doc.data());
                } else {
                    setDoc(doc.ref, { isOpen: true }).catch(error => console.error("Error setting initial store status:", error));
                }
            }, (error) => console.error("Error fetching store status:", error)));

            // Cleanup listeners on component unmount
            return () => unsubscribers.forEach(unsub => unsub());
          }, []); // <-- Empty dependency array ensures this runs only once

          // Memoized calculations
          const total = useMemo(() => cart.reduce((s, i) => s + i.qty * i.price, 0), [cart]);
          const pendingOrderCount = useMemo(() => orders.filter(o => o.status === 'pending').length, [orders]);
          const displayMenu = useMemo(() => {
            const promoItems = menu.filter(item => item.isPromo && item.available);
            const promoItemIds = new Set(promoItems.map(item => item.id));
            const categorizedItems = categories
              .map(cat => ({
                category: cat.name,
                items: menu.filter(item => item.category === cat.name && !promoItemIds.has(item.id))
              }))
              .filter(group => group.items.length > 0);
            return { promos: promoItems, categorized: categorizedItems };
          }, [menu, categories]);

          // Cart functions
          const increaseQty = (m) => {
            if (!storeStatus.isOpen || !m.available) return;
            setCart(prevCart => {
                const existingItem = prevCart.find(c => c.id === m.id);
                if (existingItem) {
                    return prevCart.map(c => c.id === m.id ? { ...c, qty: c.qty + 1 } : c);
                }
                return [...prevCart, { id: m.id, name: m.name, price: m.price, qty: 1, note: '' }];
            });
          };
          const decreaseQty = (id) => {
            setCart(prevCart => {
                const existingItem = prevCart.find(c => c.id === id);
                if (!existingItem) return prevCart;
                if (existingItem.qty === 1) {
                    return prevCart.filter(c => c.id !== id);
                }
                return prevCart.map(c => c.id === id ? { ...c, qty: c.qty - 1 } : c);
            });
          };
          const updateCartItemNote = (id, note) => { setCart(cart.map(item => item.id === id ? { ...item, note } : item)); };
          
          // Checkout
          const checkout = async () => {
            const phoneRegex = /^0\d{9}$/;
            if (!phoneRegex.test(contact)) {
                alert("Số điện thoại không hợp lệ. Vui lòng nhập 10 số, bắt đầu bằng 0.");
                return;
            }
            if (cart.length === 0) return;
            try {
                const newOrder = { items: cart, total, contact: contact.trim(), status: "pending", payment: paymentMethod, createdAt: Date.now() };
                await addDoc(collection(db, "orders"), newOrder);
                setCart([]); 
                setOpenCart(false); 
                setContact("");
            } catch (error) {
                console.error("Error placing order: ", error);
                alert("Đã có lỗi xảy ra khi đặt hàng. Vui lòng thử lại.");
            }
          };

          // Admin functions
          const updateOrderStatus = async (orderId, status) => {
              try {
                  await updateDoc(doc(db, "orders", orderId), { status });
              } catch (error) {
                  console.error("Error updating order status: ", error);
                  alert("Lỗi cập nhật trạng thái đơn hàng.");
              }
          };
          const handleAddNewItem = async () => {
              if(!newItem.name.trim() || newItem.price === '' || !newItem.category) return;
              try {
                  const newItemData = { 
                      name: newItem.name.trim(), 
                      price: Number(newItem.price), 
                      compareAtPrice: newItem.compareAtPrice === '' ? 0 : Number(newItem.compareAtPrice), 
                      available: true, 
                      category: newItem.category, 
                      photo: newItem.photo || `https://placehold.co/500x400/cccccc/ffffff?text=No+Image`,
                      isPromo: false, bestSeller: false, order: menu.length 
                  };
                  await addDoc(collection(db, "menu"), newItemData);
                  setNewItem({ name: "", price: "", compareAtPrice: "", photo: "", category: newItem.category });
              } catch (error) {
                  console.error("Error adding new item: ", error);
                  alert("Lỗi khi thêm món mới.");
              }
          };
          
          // ===== BẮT ĐẦU PHẦN SỬA LỖI =====
          const handleDeleteItem = async () => {
              if (!itemToDelete) return;
              try {
                  const deletedItemOrder = itemToDelete.order;
                  
                  // 1. Delete the document
                  await deleteDoc(doc(db, "menu", itemToDelete.id));
                  
                  // 2. Find all items with an order greater than the deleted one from the current state
                  const itemsToUpdate = menu.filter(item => item.order > deletedItemOrder);

                  // 3. Create promises to decrement their order by 1
                  const updates = itemsToUpdate.map(item => 
                      updateDoc(doc(db, "menu", item.id), { order: item.order - 1 })
                  );

                  // 4. Execute all updates
                  await Promise.all(updates);
                  setItemToDelete(null); // Close modal after everything is done
              } catch (error) {
                  console.error("Error deleting item: ", error);
                  alert("Lỗi khi xóa món.");
              }
          };

          const moveItem = async (index, direction) => {
              const newIndex = direction === 'up' ? index - 1 : index + 1;
              if (newIndex < 0 || newIndex >= menu.length) return;

              const itemA = menu[index];
              const itemB = menu[newIndex];

              // Swap the 'order' fields of the two documents
              const updateA = updateDoc(doc(db, "menu", itemA.id), { order: itemB.order });
              const updateB = updateDoc(doc(db, "menu", itemB.id), { order: itemA.order });

              try {
                  await Promise.all([updateA, updateB]);
              } catch (error) {
                  console.error("Error moving item: ", error);
                  alert("Lỗi khi sắp xếp món.");
              }
          };
          // ===== KẾT THÚC PHẦN SỬA LỖI =====

          const updateItem = async (id, data) => {
              try {
                  await updateDoc(doc(db, "menu", id), data);
              } catch (error) {
                  console.error("Error updating item: ", error);
                  alert("Lỗi khi cập nhật món.");
              }
          };
          const handleAddCategory = async () => {
              if (!newCategory.trim() || categories.find(c => c.name === newCategory.trim())) return;
              try {
                  await addDoc(collection(db, "categories"), { name: newCategory.trim() });
                  setNewCategory("");
              } catch (error) {
                  console.error("Error adding category: ", error);
                  alert("Lỗi khi thêm danh mục.");
              }
          };
          const handleDeleteCategory = async () => {
              if (!categoryToDelete) return;
              try {
                  await deleteDoc(doc(db, "categories", categoryToDelete.id));
                  setCategoryToDelete(null);
              } catch (error) {
                  console.error("Error deleting category: ", error);
                  alert("Lỗi khi xóa danh mục.");
              }
          };
          const toggleStoreStatus = async () => {
              try {
                  await updateDoc(doc(db, "settings", "storeStatus"), { isOpen: !storeStatus.isOpen });
              } catch (error) {
                  console.error("Error toggling store status: ", error);
                  alert("Lỗi khi thay đổi trạng thái cửa hàng.");
              }
          };

          // Helper functions
          const handleContactChange = (e) => {
              const value = e.target.value.replace(/\D/g, '');
              if (value.length <= 10) { setContact(value); }
          };
          const handleImageUpload = (event) => {
            const file = event.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => { setNewItem({ ...newItem, photo: reader.result }); };
                reader.readAsDataURL(file);
            }
          };
          const getStatusDisplay = (status) => {
              switch (status) {
                  case 'pending': return { text: 'Đang chờ', className: 'bg-yellow-100 text-yellow-800' };
                  case 'processing': return { text: 'Đang thực hiện', className: 'bg-blue-100 text-blue-800' };
                  case 'completed': return { text: 'Hoàn thành', className: 'bg-green-100 text-green-800' };
                  case 'canceled': return { text: 'Đã hủy', className: 'bg-red-100 text-red-800' };
                  default: return { text: 'Không xác định', className: 'bg-gray-100 text-gray-800' };
              }
          };

          if (loading) {
              return <div className="min-h-screen flex items-center justify-center">Đang tải dữ liệu...</div>
          }

          return (
            <div className="min-h-screen">
              <header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
                <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                  <div><h1 className="font-bold text-lg">BÁNH MÌ ÔNG KÒI</h1><p className="text-xs text-neutral-500">Giao hàng tận nơi</p></div>
                </div>
              </header>

              <main className="max-w-md mx-auto px-4 pb-28">
                <div className="w-full grid grid-cols-2 rounded-2xl my-4 bg-neutral-200 p-1">
                    <button onClick={() => setTab('khach')} className={`py-2 rounded-[14px] text-sm font-semibold ${tab === 'khach' ? 'bg-white shadow' : 'text-neutral-600'}`}>Khách hàng</button>
                    <button onClick={() => setTab('admin')} className={`relative py-2 rounded-[14px] text-sm font-semibold ${tab === 'admin' ? 'bg-white shadow' : 'text-neutral-600'}`}>
                        Admin
                        {pendingOrderCount > 0 && <span className="absolute top-1 right-2 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">{pendingOrderCount}</span>}
                    </button>
                </div>

                {tab === 'khach' && (
                  <div>
                    {!storeStatus.isOpen && (
                        <div className="p-4 mb-4 text-center bg-red-100 text-red-800 rounded-lg">
                            <p className="font-bold">Cửa hàng đang tạm đóng cửa!</p>
                        </div>
                    )}
                    {displayMenu.promos.length > 0 && (
                        <section className="mt-2">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-lg font-bold">Ưu đãi hôm nay</h3>
                                <button className="text-gray-500 hover:text-gray-800 p-1">
                                    <ArrowRightIcon />
                                </button>
                            </div>
                            <div className="flex space-x-3 overflow-x-auto pb-3 -mx-4 px-4 scrollbar-hide">
                                {displayMenu.promos.map(m => {
                                    const cartItem = cart.find(c => c.id === m.id);
                                    const qty = cartItem ? cartItem.qty : 0;
                                    return (
                                        <div key={m.id} className="w-64 flex-shrink-0">
                                            <Card className="p-2 h-full">
                                                <div className="flex h-full items-center">
                                                    <img src={m.photo} alt={m.name} className="w-20 h-20 object-cover rounded-lg flex-shrink-0" onError={(e) => { e.currentTarget.src = 'https://placehold.co/100/fef2f2/ef4444?text=Lỗi'; }}/>
                                                    <div className="flex flex-col justify-between flex-1 ml-3 h-20">
                                                        <div>
                                                            <p className="text-sm font-medium leading-tight" style={{ display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden' }}>{m.name}</p>
                                                        </div>
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex items-baseline gap-2">
                                                                <p className="font-semibold text-sm">{vnd(m.price)}</p>
                                                                {m.compareAtPrice > 0 && <p className="text-xs text-neutral-400 line-through">{vnd(m.compareAtPrice)}</p>}
                                                            </div>
                                                            <div className="self-end">
                                                                {qty > 0 ? (
                                                                    <div className="flex items-center gap-1">
                                                                        <Button size="icon" variant="outline" className="rounded-full w-7 h-7" onClick={() => decreaseQty(m.id)}><MinusIcon/></Button>
                                                                        <span className="font-bold w-5 text-center">{qty}</span>
                                                                        <Button size="icon" className="rounded-full w-7 h-7" onClick={() => increaseQty(m)}><PlusIcon/></Button>
                                                                    </div>
                                                                ) : (
                                                                    <Button size="icon" className="rounded-full w-8 h-8" disabled={!m.available || !storeStatus.isOpen} onClick={() => increaseQty(m)}>
                                                                        <PlusIcon/>
                                                                    </Button>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </Card>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>
                    )}

                    <div className="mt-5 space-y-6">{displayMenu.categorized.map(group => (<section key={group.category}><h3 className="text-lg font-bold mb-3">{group.category}</h3><div className="grid grid-cols-2 gap-4">{group.items.map(m => { const cartItem = cart.find(c => c.id === m.id); const qty = cartItem ? cartItem.qty : 0; return (<Card key={m.id} className="overflow-hidden"><div className="relative"><img src={m.photo} alt={m.name} className="w-full h-36 object-cover" onError={(e) => { e.currentTarget.src = 'https://placehold.co/200x150/fef2f2/ef4444?text=Lỗi'; } }/>{m.bestSeller && <span className="absolute top-2 left-2 text-xs px-2 py-1 rounded-full bg-emerald-500 text-white">Bán chạy</span>}{!m.available && <div className="absolute inset-0 bg-black/50 flex items-center justify-center"><span className="text-white font-semibold">Hết hàng</span></div>}</div><CardContent><div className="text-sm font-medium min-h-10">{m.name}</div><div className="flex items-center justify-between mt-1"><div><div className="font-semibold">{vnd(m.price)}</div>{m.compareAtPrice > 0 && <div className="text-xs text-neutral-400 line-through">{vnd(m.compareAtPrice)}</div>}</div>{qty > 0 ? (<div className="flex items-center gap-1"><Button size="icon" variant="outline" className="rounded-full w-7 h-7" onClick={() => decreaseQty(m.id)}><MinusIcon/></Button><span className="font-bold w-5 text-center">{qty}</span><Button size="icon" className="rounded-full w-7 h-7" onClick={() => increaseQty(m)}><PlusIcon/></Button></div>) : (<Button size="icon" className="rounded-full w-8 h-8" disabled={!m.available || !storeStatus.isOpen} onClick={() => increaseQty(m)}><PlusIcon/></Button>)}</div></CardContent></Card>)})}</div></section>))}</div>
                  </div>
                )}
                
                {tab === 'admin' && (
                  <div>
                    <div className="grid grid-cols-2 gap-2 my-4 p-1 bg-neutral-200 rounded-lg">
                        <button onClick={() => setAdminTab('orders')} className={`py-2 rounded-md text-sm font-semibold relative ${adminTab === 'orders' ? 'bg-white shadow' : ''}`}>
                            Đơn hàng
                            {pendingOrderCount > 0 && <span className="absolute top-1 right-2 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">{pendingOrderCount}</span>}
                        </button>
                        <button onClick={() => setAdminTab('menu')} className={`py-2 rounded-md text-sm font-semibold ${adminTab === 'menu' ? 'bg-white shadow' : ''}`}>Thực đơn & Cài đặt</button>
                    </div>

                    {adminTab === 'orders' && (
                        <section>
                            <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2">{orders.length === 0 && <p className="text-sm text-neutral-500 text-center py-10">Chưa có đơn hàng nào.</p>}{orders.map(order => { const statusDisplay = getStatusDisplay(order.status); return (<Card key={order.id}><CardContent><div className="flex justify-between items-start"><div className="flex-1"><div className="font-bold">#{order.id.slice(-6)} - <span className="font-normal">{order.contact}</span></div><div className="text-xs text-neutral-500">{new Date(order.createdAt).toLocaleString('vi-VN')}</div></div><div className="text-right flex-shrink-0 ml-4"><div className="font-bold text-lg" style={{color: BRAND_COLOR}}>{vnd(order.total)}</div><div className={`text-xs font-semibold px-2 py-1 rounded-full mt-1 inline-block ${statusDisplay.className}`}>{statusDisplay.text}</div></div></div><div className="text-xs mt-2">Thanh toán: <span className="font-semibold">{order.payment === 'TIENMAT' ? 'Tiền mặt' : 'Chuyển khoản'}</span></div><div className="border-t my-2"></div><ul className="text-sm space-y-2">{order.items.map(item => <li key={item.id} className="flex flex-col"><span className="font-medium">{item.qty} x {item.name}</span>{item.note && (<div className="flex items-center text-xs text-blue-600 pl-4"><NoteIcon /><span>{item.note}</span></div>)}</li>)}</ul>{order.status === 'pending' && (<div className="flex gap-2 mt-3"><Button size="sm" className="flex-1" onClick={() => updateOrderStatus(order.id, 'processing')}>Xác nhận</Button><Button size="sm" variant="destructive" className="flex-1" onClick={() => updateOrderStatus(order.id, 'canceled')}>Hủy đơn</Button></div>)}{order.status === 'processing' && (<div className="flex gap-2 mt-3"><Button size="sm" className="flex-1" onClick={() => updateOrderStatus(order.id, 'completed')}>Hoàn thành</Button></div>)}</CardContent></Card>)})}</div>
                        </section>
                    )}

                    {adminTab === 'menu' && (
                        <div className="space-y-8">
                            <section>
                                <h3 className="text-base font-semibold mb-3">Tình trạng Cửa hàng</h3>
                                <div className="flex items-center justify-between bg-white p-3 rounded-lg border">
                                    <span className={`font-bold ${storeStatus.isOpen ? 'text-green-600' : 'text-red-600'}`}>
                                        {storeStatus.isOpen ? 'ĐANG MỞ CỬA' : 'ĐANG TẠM ĐÓNG CỬA'}
                                    </span>
                                    <button onClick={toggleStoreStatus} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${storeStatus.isOpen ? 'bg-green-500' : 'bg-gray-300'}`}>
                                        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${storeStatus.isOpen ? 'translate-x-6' : 'translate-x-1'}`}/>
                                    </button>
                                </div>
                            </section>
                            <section>
                                <h3 className="text-base font-semibold mb-2">Thống kê nhanh</h3>
                                <div className="grid grid-cols-3 gap-3">
                                    <Card><CardContent className="text-center"><div className="text-xs text-neutral-500">Doanh thu</div><div className="text-lg font-bold" style={{ color: BRAND_COLOR }}>{vnd(orders.filter(o=>o.status==='completed').reduce((s,o)=>s+o.total,0))}</div></CardContent></Card>
                                    <Card><CardContent className="text-center"><div className="text-xs text-neutral-500">Số đơn</div><div className="text-lg font-bold">{orders.length}</div></CardContent></Card>
                                    <Card><CardContent className="text-center"><div className="text-xs text-neutral-500">Đang chờ</div><div className="text-lg font-bold">{pendingOrderCount}</div></CardContent></Card>
                                </div>
                            </section>
                            <section>
                                <h3 className="text-base font-semibold mb-3">Thêm món mới</h3>
                                <div className="grid grid-cols-2 gap-3"><Input className="col-span-2" placeholder="Tên món" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})} /><Input placeholder="Giá bán (VND)" type="number" value={newItem.price} onChange={e=>setNewItem({...newItem, price: e.target.value})} /><Input placeholder="Giá gốc (để gạch)" type="number" value={newItem.compareAtPrice} onChange={e=>setNewItem({...newItem, compareAtPrice: e.target.value})} /><div className="col-span-2 flex items-center gap-3"><label className="flex-1 cursor-pointer"><div className="h-24 w-full border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-neutral-500 hover:bg-neutral-50 transition-colors"><UploadIcon /><span className="text-xs mt-1">Tải ảnh lên</span></div><input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} /></label>{newItem.photo && (<div className="w-24 h-24 rounded-lg overflow-hidden border flex-shrink-0"><img src={newItem.photo} alt="Xem trước" className="w-full h-full object-cover" /></div>)}</div><Select className="col-span-2" value={newItem.category} onChange={e=>setNewItem({...newItem, category: e.target.value})}><option value="" disabled>-- Chọn danh mục --</option>{categories.map(c => <SelectItem key={c.id} value={c.name}>{c.name}</SelectItem>)}</Select><Button className="rounded-xl col-span-2" onClick={handleAddNewItem}>Thêm món vào thực đơn</Button></div>
                            </section>
                            <section>
                                <h3 className="text-base font-semibold mb-3">Quản lý & Sắp xếp Thực đơn</h3>
                                <div className="space-y-3">{menu.map((m, index) => (<Card key={m.id}><CardContent className="flex flex-col gap-3"><div className="flex items-start gap-3"><div className="flex flex-col items-center gap-2 pt-1"><Button size="sm" variant="outline" className="p-2" disabled={index === 0} onClick={() => moveItem(index, 'up')}><ArrowUpIcon /></Button><span className="font-bold text-lg">{index + 1}</span><Button size="sm" variant="outline" className="p-2" disabled={index === menu.length - 1} onClick={() => moveItem(index, 'down')}><ArrowDownIcon /></Button></div><img src={m.photo} alt={m.name} className="w-20 h-20 object-cover rounded-xl" onError={(e) => { e.currentTarget.src = 'https://placehold.co/100/fef2f2/ef4444?text=Lỗi'; }}/><div className="flex-1"><div className="font-medium">{m.name}</div><div className="text-sm text-neutral-500">Danh mục: {m.category}</div><div className="text-sm">Giá: {vnd(m.price)} {m.compareAtPrice > 0 && <span className="text-neutral-400 line-through ml-1">{vnd(m.compareAtPrice)}</span>}</div></div></div><div className="grid grid-cols-4 gap-2"><Button size="sm" variant="outline" className="text-xs" onClick={()=> updateItem(m.id, { isPromo: !m.isPromo })}><PinIcon /> {m.isPromo ? 'Bỏ ghim' : 'Ghim'}</Button><Button size="sm" variant="outline" className="text-xs" onClick={()=> updateItem(m.id, { bestSeller: !m.bestSeller })}><StarIcon /> {m.bestSeller ? 'Bỏ Tag' : 'Bán chạy'}</Button><Button size="sm" variant="outline" className="text-xs" onClick={()=> updateItem(m.id, { available: !m.available })}>{m.available? 'Tắt món':'Bật món'}</Button><Button size="sm" variant="destructive" className="text-xs" onClick={() => setItemToDelete(m)}><Trash2Icon /> Xóa</Button></div></CardContent></Card>))}</div>
                            </section>
                            <section>
                                <h3 className="text-base font-semibold mb-3">Quản lý Danh mục</h3>
                                <div className="space-y-2">{categories.map(cat => (<div key={cat.id} className="flex items-center justify-between bg-white p-2 rounded-lg border"><span className="text-sm">{cat.name}</span><Button size="sm" variant="destructive" className="text-xs" onClick={() => setCategoryToDelete(cat)}>Xóa</Button></div>))}</div>
                                <div className="flex gap-2 mt-3"><Input placeholder="Tên danh mục mới" value={newCategory} onChange={e => setNewCategory(e.target.value)} /><Button onClick={() => handleAddCategory(newCategory)}>Thêm</Button></div>
                            </section>
                            
                            {/* Modal Windows */}
                            {itemToDelete && (<div className="fixed inset-0 z-[60] flex items-center justify-center"><div className="absolute inset-0 bg-black/60" onClick={() => setItemToDelete(null)}></div><div className="relative bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm m-4"><h3 className="text-lg font-semibold">Xác nhận xóa món?</h3><p className="text-sm text-neutral-500 mt-1">Bạn có chắc muốn xóa món <span className="font-bold">"{itemToDelete.name}"</span>?</p><div className="flex justify-end gap-2 mt-4"><Button variant="outline" onClick={() => setItemToDelete(null)}>Hủy</Button><Button variant="destructive" onClick={handleDeleteItem}>Xác nhận xóa</Button></div></div></div>)}
                            {categoryToDelete && (<div className="fixed inset-0 z-[60] flex items-center justify-center"><div className="absolute inset-0 bg-black/60" onClick={() => setCategoryToDelete(null)}></div><div className="relative bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm m-4"><h3 className="text-lg font-semibold">Xác nhận xóa danh mục?</h3><p className="text-sm text-neutral-500 mt-1">Bạn có chắc muốn xóa danh mục <span className="font-bold">"{categoryToDelete.name}"</span>?</p><div className="flex justify-end gap-2 mt-4"><Button variant="outline" onClick={() => setCategoryToDelete(null)}>Hủy</Button><Button variant="destructive" onClick={handleDeleteCategory}>Xác nhận xóa</Button></div></div></div>)}
                        </div>
                    )}
                  </div>
                )}
              </main>

              {/* Cart Button & Modal */}
              {cart.length > 0 && tab === 'khach' && (<div className="fixed bottom-0 left-0 right-0 z-30"><div className="max-w-md mx-auto p-2"><Button className="w-full h-12 rounded-xl text-base" onClick={()=> setOpenCart(true)}><div className="flex items-center justify-between w-full"><span>{cart.reduce((s,i)=>s+i.qty,0)} món</span><span className="font-bold">{vnd(total)}</span></div></Button></div></div>)}
              {openCart && (<div className="fixed inset-0 z-50 flex flex-col justify-end">
                  <div className="absolute inset-0 bg-black/60" onClick={() => setOpenCart(false)}></div>
                  <div className={`relative bg-white rounded-t-2xl shadow-xl flex flex-col max-h-[80vh] transition-transform duration-300 ${openCart ? 'translate-y-0' : 'translate-y-full'}`}>
                      <div className="p-4 border-b flex-shrink-0"><h2 className="text-lg font-semibold text-center">Tóm tắt đơn hàng</h2></div>
                      <div className="flex-1 p-4 space-y-3 overflow-y-auto">{cart.map(c => (<Card key={c.id}><CardContent><div className="flex-1"><div className="flex items-center justify-between"><div className="font-medium">{c.name}</div><div className="text-sm text-neutral-600">{vnd(c.price * c.qty)}</div></div><div className="mt-2 flex items-center gap-2"><Button size="icon" variant="outline" className="rounded-full w-8 h-8" onClick={()=>decreaseQty(c.id)}><MinusIcon/></Button><div className="w-10 text-center font-semibold">{c.qty}</div><Button size="icon" variant="outline" className="rounded-full w-8 h-8" onClick={()=>increaseQty(c)}><PlusIcon/></Button></div><Textarea className="mt-2 text-sm" placeholder="Ghi chú (ít ớt, không rau…)" value={c.note||""} onChange={e => updateCartItemNote(c.id, e.target.value)}/></div></CardContent></Card>))}</div>
                      <div className="p-4 border-t bg-white space-y-3 flex-shrink-0">
                          <Input placeholder="SĐT/Zalo (10 số, bắt đầu bằng 0)" value={contact} onChange={handleContactChange} type="tel" maxLength={10} />
                          <div>
                              <div className="text-sm font-medium mb-2">Phương thức thanh toán</div>
                              <div className="grid grid-cols-2 gap-2">
                                  <button onClick={() => setPaymentMethod('TIENMAT')} className={`p-3 rounded-lg border text-sm text-center ${paymentMethod === 'TIENMAT' ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-500' : 'bg-neutral-100'}`}>Tiền mặt</button>
                                  <button onClick={() => setPaymentMethod('CHUYENKHOAN')} className={`p-3 rounded-lg border text-sm text-center ${paymentMethod === 'CHUYENKHOAN' ? 'border-orange-500 bg-orange-50 ring-2 ring-orange-500' : 'bg-neutral-100'}`}>Chuyển khoản</button>
                              </div>
                          </div>
                          <div className="flex items-center justify-between font-semibold text-lg"><span>Tổng cộng</span><span style={{ color: BRAND_COLOR }}>{vnd(total)}</span></div>
                          <Button className="w-full h-12 rounded-xl text-base" onClick={checkout}>Đặt hàng</Button>
                      </div>
                  </div>
              </div>)}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
